<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="baidu-site-verification" content="vuaTJrjFLn" />
    <meta name="keywords" content="foolchild,linux,java,技术,互联网" />
    <meta name="description" content="技术博客，记录foolchild技术道路上成长的点滴" />
    <title> equal & hashcode  </title>
    <link rel="stylesheet" href="/css/default.css" type="text/css"/>
    <link rel="stylesheet" href="/css/small.css" type="text/css" media="(max-width: 720px)"/>
    <link rel="stylesheet" href="/css/syntax.css" type="text/css"/>
    <link rel="stylesheet" href="/css/bootstrap.css" type="text/css"/>
    <link rel="stylesheet" href="/css/codeboy.css" type="text/css"/>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
</head>
<body>
<div id="container">
    <div class="nav">
    <div class="nav_nav">
        <a href="/">首页</a>
        <a href="/categories.html">分类</a>
        <a href="/booklist.html">书单</a>
        <a href="/about.html">关于</a>
    </div>
</div>

    <div id="main">
        <h2> equal & hashcode </h2>
        <ul>
  <li><a href="#summary">概述</a></li>
  <li><a href="#relation">hashCode和equals关系</a></li>
  <li><a href="#equals">实现equals</a></li>
  <li><a href="#hashcode">实现hashCode</a></li>
  <li><a href="#qAnda">Q&amp;A</a>
    <ul>
      <li><a href="#hashCode_hash_based">hashCode为什么能够提升hash-based的Collection和Map的性能</a></li>
    </ul>
  </li>
  <li><a href="#example">一道题目</a></li>
  <li><a href="#ref">参考</a></li>
</ul>

<h3 id="summary">概述</h3>
<p>equals() 和 hashCode()是java中Object类中两个基本的方法</p>

<p>equals():</p>

<ul>
  <li>== (引用相等)是比较两个对象的在内存中的地址是否相同</li>
  <li>equals() (逻辑相等)比较的是两个对象的数据是否想等</li>
</ul>

<p>hashCode():</p>

<p>对于包含容器类型的程序设计语言来说,基本上都会设计到hashCode.在java中也一样,hashCode方法的主要作用是为了配合基于散列的集合一起正常运行,如hashSet,hashMap等
用于快速定位对象.</p>

<h3 id="relation">hashCode和equals关系</h3>

<ol>
  <li>如果你重写了equals方法,你必须重写hashCode方法</li>
  <li>关系:
    <ul>
      <li><strong><em>equals(逻辑相等)的对象,hashCode()一定相等;其逆否命题当然也是成立的,hashCode()不等的对象,一定不equals</em></strong></li>
      <li><strong><em>hashCode()相等的对象,不一定equals;</em></strong></li>
    </ul>
  </li>
  <li>equals和hashCode应使用相同的域(<code class="highlighter-rouge">same set of "significant" fields</code>),当然不一定是所有域,你看着办.</li>
  <li>当使用基于hash的Collection和Map如 HashSet,LinkedHashSet,HashMap,HashTable,WeakHashMap,确保key的hashCode()是不可变的</li>
</ol>

<h3 id="equals">实现equals</h3>

<p>当实现equals,根据类型不同,采用不同的比较方法</p>

<ol>
  <li>对象域包括collections :equals</li>
  <li>类型安全的枚举 : equals或者==</li>
  <li>可能为空的对象域 : ==和equals</li>
  <li>数据域 : Arrays.equals</li>
  <li>除了float和equals的基本类型 : ==</li>
  <li>float : 通过Float.floatToIntBits转化为int ,然后使用 ==</li>
  <li>double : 通过Double.doubleToLongBits转化为int ,然后使用 ==</li>
</ol>

<p>很多人认为hashCode是一个对象的唯一标识,其实这是不对的.在java中equals方法必须满足<code class="highlighter-rouge">自反性</code>,<code class="highlighter-rouge">对称性</code>,<code class="highlighter-rouge">传递性</code>,<code class="highlighter-rouge">一致性</code>,且obj.equals(null)肯定返回false
重写equals的最加实践是:</p>

<ul>
  <li>使用==来检查引用的相等性</li>
  <li>使用instanceof 来检测参数类型</li>
  <li>cast参数到正确的类型</li>
  <li>按照上边的比较方法比较你觉得有意义的域的相等性</li>
</ul>

<p>看下String的equals方法</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public boolean equals(Object anObject) {
    if (this == anObject) {
        return true;
    }
    if (anObject instanceof String) {
        String anotherString = (String) anObject;
        int n = value.length;
        if (n == anotherString.value.length) {
            char v1[] = value;
            char v2[] = anotherString.value;
            int i = 0;
            while (n-- != 0) {
                if (v1[i] != v2[i])
                        return false;
                i++;
            }
            return true;
        }
    }
    return false;
}
</code></pre>
</div>

<p>还可以使用apache的工具类<a href="http://commons.apache.org/proper/commons-lang/apidocs/org/apache/commons/lang3/builder/EqualsBuilder.html">EqualsBuilder</a></p>

<h3 id="hashcode">实现hashCode</h3>

<ol>
  <li>把某个非零常数值保存在int变量result中</li>
  <li>对于对象的每一个关键域f(equals方法中考虑的每一个域)
    <ul>
      <li>boolean 计算 <code class="highlighter-rouge">f ? 0 :1</code></li>
      <li>byte,char,short 计算<code class="highlighter-rouge">(int) f</code></li>
      <li>long    计算<code class="highlighter-rouge">(int)(f^(f\&gt;\&gt;\&gt;32))</code></li>
      <li>float   计算<code class="highlighter-rouge">Float.floatToIntBits(f)</code></li>
      <li>double  计算<code class="highlighter-rouge">Double.doubleToLongBits(f)</code>得到一个long,然后计算<code class="highlighter-rouge">(int)(f^(f\&gt;\&gt;\&gt;32))</code>;</li>
      <li>对象引用 调用它的hashCode方法<code class="highlighter-rouge">f.hashCode()</code></li>
      <li>数组域,对其中每个元素调用它的hashCode方法.</li>
    </ul>
  </li>
  <li>将上面计算得到的散列码保存到int变量c中,然后执行<code class="highlighter-rouge">result = 37 * result + c</code></li>
  <li>返回result</li>
</ol>

<p>ps:
用37这样的素数，可以让各种对象的hashcode值分布散列一些，为了减少下面这种情况的发生，不同对象虽然每个实例变量不同，还是可能计算出来的hashCode值相同
<a href="http://stackoverflow.com/questions/8577582/on-integer-multiplication-overflow-and-information-loss">详见</a></p>

<p>还可以使用apache的工具类<a href="http://commons.apache.org/proper/commons-lang/apidocs/org/apache/commons/lang3/builder/HashCodeBuilder.html">HashCodeBuilder</a></p>

<h3 id="qAnda">Q&amp;A</h3>

<h4 id="hashCode_hash_based">hashCode为什么能够提升基于hash的Collection和Map的性能</h4>

<p>以HashMap为例,想象一下如果没有hash,你会如何查找一个map中的某个entry. 遍历HashMap中所有entry,逐一equals?这肯定是可以的,但是…</p>

<p>看下hashMap#getEntry的实现</p>

<ol>
  <li><code class="highlighter-rouge">hash(key)</code> 都是移位运算</li>
  <li><code class="highlighter-rouge">indexFor()</code> hash值与table.length - 1 进行与运算,找到hash(key)所在table的index.</li>
  <li>又因为table的length是2的n次幂,保证table数据可以均匀分配.</li>
  <li>然后遍历该table[index]的entry,最好情况下时间复杂度为O(1),最坏也是O(n)</li>
</ol>

<p>高下立判</p>

<div class="highlighter-rouge"><pre class="highlight"><code>int hash = (key == null) ? 0 : hash(key);
for (Entry&lt;K,V&gt; e = table[indexFor(hash, table.length)];
     e != null;
     e = e.next) {
    Object k;
    // 这段逻辑是否熟悉,忘了的话看上边,再贴一遍吧
    // e.hash值等于上hash并且e.key与key逻辑相等或就是同一个引用,满足的话,就是同一个entry,返回改entry
    if (e.hash == hash &amp;&amp;
        ((k = e.key) == key || (key != null &amp;&amp; key.equals(k))))
        return e;
}
return null;
</code></pre>
</div>

<h3 id="example">一道题目</h3>

<p><a href="/2016/03/12/equals_hashcode_eg">看这里</a></p>

<h3 id="ref">参考</h3>

<p>[1]<a href="http://crunchify.com/how-to-override-equals-and-hashcode-method-in-java/">http://crunchify.com/how-to-override-equals-and-hashcode-method-in-java/</a></p>

<p>[2]<a href="http://zhangjunhd.blog.51cto.com/113473/71571">http://zhangjunhd.blog.51cto.com/113473/71571</a></p>

<p>[3]<a href="http://stackoverflow.com/questions/27581/what-issues-should-be-considered-when-overriding-equals-and-hashcode-in-java">http://stackoverflow.com/questions/27581/what-issues-should-be-considered-when-overriding-equals-and-hashcode-in-java</a></p>

<p>[4]<a href="http://www.javapractices.com/topic/TopicAction.do?Id=29">http://www.javapractices.com/topic/TopicAction.do?Id=29</a></p>

<p>[5]<a href="http://www.cnblogs.com/dolphin0520/p/3681042.html">http://www.cnblogs.com/dolphin0520/p/3681042.html</a></p>

        <ul class="prev_next">
            
            <li>
                <span>上一篇</span>
                <a href="/2016/03/07/Integer">Integer</a>
            </li>
            
            
            <li>
                <span>下一篇</span>
                <a href="/2016/03/11/sublime">sublime插件</a>
            </li>
            
        </ul>
        <div class="ds-share flat" data-thread-key="/2016/03/10/equals_hashcode" data-title="equal & hashcode"
             data-url="http://lcj1992.github.io/2016/03/10/equals_hashcode">
            <div class="ds-share-inline">
                <ul class="ds-share-icons-16">

                    <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
                    <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
                    <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

                </ul>
                <div class="ds-share-icons-more">
                </div>
            </div>
        </div>
        <div class="ds-thread" data-thread-key="/2016/03/10/equals_hashcode" data-title="equal & hashcode"
             data-url="http://lcj1992.github.io/2016/03/10/equals_hashcode"></div>
        <!-- 多说评论框 end -->
        <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
        <script type="text/javascript">
            var duoshuoQuery = {short_name: "lcj1992"};
            (function () {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';
                ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        </script>

        <!-- jQuery -->
        <script src="/js/jquery.js"></script>

        <!-- Bootstrap Core JavaScript -->
        <script src="/js/bootstrap.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/js/codeboy.js"></script>

        <script src="/js/bootstrap3-typeahead.js"></script>
        <script src="/js/jquery.hotkeys.js"></script>
        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function () {
                            (i[r].q = i[r].q || []).push(arguments)
                        }, i[r].l = 1 * new Date();
                a = s.createElement(o),
                        m = s.getElementsByTagName(o)[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-72949519-1', 'auto');
            ga('send', 'pageview');

        </script>

        <!-- TODO: only load in tag.html -->
        <script src="/js/jquery.tagcloud.js" type="text/javascript" charset="utf-8"></script>
        <script language="javascript">
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'}
            };
            $(function () {
                $('#tag_cloud a').tagcloud();
            });
        </script>

        <!-- async load function -->
        <script>
            function async(u, c) {
                var d = document, t = 'script',
                        o = d.createElement(t),
                        s = d.getElementsByTagName(t)[0];
                o.src = u;
                if (c) {
                    o.addEventListener('load', function (e) {
                        c(null, e);
                    }, false);
                }
                s.parentNode.insertBefore(o, s);
            }
        </script>

        <!-- Highlight.js -->
        <script>
            async("https://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () {
                hljs.initHighlightingOnLoad();
            })
        </script>
        <link href="https://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">


        <script>
            $(document).ready(function () {
                var time1 = 0;
                var show = false;
                var names = new Array(); //文章名字等
                var urls = new Array(); //文章地址
                $(document).keyup(function (e) {
                    var time2 = new Date().getTime();
                    if (e.keyCode == 17) {
                        var gap = time2 - time1;
                        time1 = time2;
                        if (gap < 500) {
                            if (show) {
                                $(".search-tool").css("display", "none");
                                show = false;
                            } else {
                                $(".search-tool").css("display", "block");
                                show = true;
                                $("#search-content").val("");
                                $("#search-content").focus();
                            }
                            time1 = 0;
                        }
                    } else if (e.keyCode == 27) {
                        $(".search-tool").css("display", "none");
                        show = false;
                        time1 = 0;
                    }
                });

                $("#search-content").keyup(function (e) {
                    var time2 = new Date().getTime();
                    if (window.event.keyCode == 17) {
                        var gap = time2 - time1;
                        time1 = time2;
                        if (gap < 500) {
                            if (show) {
                                $(".search-tool").css("display", "none");
                                show = false;
                            } else {
                                $(".search-tool").css("display", "block");
                                show = true;
                                $("#search-content").val("");
                                $("#search-content").focus();
                            }
                            time1 = 0;
                        }
                    }
                });

                $("#close-btn").click(function () {
                    $(".search-tool").css("display", "none");
                    show = false;
                    time1 = 0;
                });

                $("#search-btn").click(function () {
                    $(".search-tool").css("display", "block");
                    show = true;
                    $("#search-content").val("");
                    $("#search-content").focus();
                    time1 = 0;
                });
                // 家目录快捷键
                $(document).bind('keydown', 'alt+h', function () {
                    window.location.href = "/";
                });
                // 目录快捷键
                $(document).bind('keydown', 'alt+c', function () {
                    window.location.href = "/categories.html";
                });
                // 个人介绍页快捷键
                $(document).bind('keydown', 'alt+a', function () {
                    window.location.href = "/about.html";
                });
                // 上一篇
                $(document).bind('keydown', 'alt+p', function () {
                    window.location.href = "/2016/03/07/Integer";
                });
                // 下一篇
                $(document).bind('keydown', 'alt+n', function () {
                    window.location.href = "/2016/03/11/sublime";
                });

                $.getJSON("/search.json").done(function (data) {
                    if (data.code == 0) {
                        for (var index in data.data) {
                            var item = data.data[index];
                            names.push(item.title);
                            urls.push(item.url);
                        }

                        $("#search-content").typeahead({
                            source: names,

                            afterSelect: function (item) {
                                $(".search-tool").css("display", "none");
                                show = false;
                                window.location.href = (urls[names.indexOf(item)]);
                                return item;
                            }
                        });
                    }
                });

            });
        </script>

        <style>
            @media screen and (min-width: 768px) {
                .dropdown-menu {
                    float: none;
                    font-size: 20px;
                    width: 70%;
                    margin: 0 15%;
                }

                .search-tool ul {
                    width: 70%;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                .search-content {
                    width: 70%;
                    margin: 0 15%;
                    position: absolute;
                    top: 13%;
                    left: auto;
                    right: auto;
                    font-size: 22px;
                    height: 50px;
                    background-color: #eee;
                    color: black;
                    opacity: 1.0;
                }
            }

            @media screen and (max-width: 767px) {
                .dropdown-menu {
                    float: none;
                    font-size: 20px;
                    width: 96%;
                    margin: 0 2%;
                }

                .search-tool ul {
                    width: 96%;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                .search-content {
                    width: 96%;
                    margin: 0 2%;
                    position: absolute;
                    top: 10%;
                    left: auto;
                    right: auto;
                    font-size: 22px;
                    height: 50px;
                    background-color: #eee;
                    color: black;
                    opacity: 1.0;
                }
            }
        </style>
        <div class="search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right:  0px;
      opacity: 0.95; background-color: #111111; z-index: 9999; display: none;">
            <input type="text" class="form-control search-content" id="search-content" placeholder="文章标题 日期 标签">

            <div style="position: fixed; top: 16px; right: 16px;">
                <img src="/images/search/close.png" id="close-btn"/>
            </div>
        </div>

        <div style="position: fixed; right: 12px; top: 50%;bottom: 50%;">
            <img src="/images/search/search.png" id="search-btn" title="双击ctrl试一下"/>
        </div>

    </div>
</div>
</body>
</html>


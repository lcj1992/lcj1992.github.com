<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="baidu-site-verification" content="vuaTJrjFLn" />
    <meta name="keywords" content="foolchild,linux,java,技术,互联网" />
    <meta name="description" content="技术博客，记录foolchild技术道路上成长的点滴" />
    <title> redis源码分析  </title>
    <link rel="stylesheet" href="/css/default.css" type="text/css"/>
    <link rel="stylesheet" href="/css/small.css" type="text/css" media="(max-width: 720px)"/>
    <link rel="stylesheet" href="/css/syntax.css" type="text/css"/>
    <link rel="stylesheet" href="/css/bootstrap.css" type="text/css"/>
    <link rel="stylesheet" href="/css/codeboy.css" type="text/css"/>
    <link rel="stylesheet" href="/css/donate.css" type="text/css"/>
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"/>
</head>
<body>
<div id="container">
    <div class="nav">
    <div class="nav_nav">
        <a href="/">首页</a>
        <a href="/categories.html">目录</a>
        <a href="/booklist.html">书单</a>
        <a href="/about.html">关于</a>
    </div>
</div>

    <div id="main">
        <h2> redis源码分析 </h2>
        <ul>
  <li><a href="#memory">内存结构</a></li>
  <li><a href="#obj">对象</a></li>
  <li><a href="#ds">数据结构</a>
    <ul>
      <li><a href="#sds">sds</a></li>
      <li><a href="#list">list</a></li>
      <li><a href="#dict">dict</a></li>
      <li><a href="#skipList">skipList</a></li>
      <li><a href="#intSet">intSet</a></li>
      <li><a href="#zipList">ziplist</a></li>
    </ul>
  </li>
  <li><a href="#debug_redis">调试redis</a></li>
  <li><a href="#redis_start">redis启动流程</a></li>
  <li><a href="#redis_accept_request">redis接收请求</a>
    <ul>
      <li><a href="#reactor">reactor</a></li>
    </ul>
  </li>
  <li><a href="#redis_distributed">redis多机</a></li>
  <li><a href="#redis_situation">使用场景</a></li>
</ul>

<h3 id="memory">内存结构</h3>

<p>首先需要明确的是redis是一个key-value存储。</p>

<ol>
  <li>key就是字符串，而value的可以是:string、list、map、set、sort set、(bitmaps、hyperloglogs、geospatial indexes)。</li>
  <li>各种value对应的是字符串对象、list object(列表对象)、hash object(哈希对象)、set object(集合对象)、sorted set object(有序集合对象)。</li>
  <li>每一种对象又是由这些数据结构组成的:sds(c string的变种)、list、dict、skipList、intSet、 zipList。</li>
  <li>一种对象可以底层对应多种数据结构实现，eg列表对象底层可能是list或者ziplist，可以进行转换。</li>
</ol>

<p>其结构图如下：</p>

<p><img src="/images/soft/redisServer.png" alt="redis结构" /></p>

<h3 id="obj">对象</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>typedef struct redisObject {

    // 类型          
    unsigned type:4;

    // 编码
    // 
    unsigned encoding:4;

    // 对象最后一次被访问的时间
    unsigned lru:REDIS_LRU_BITS; /* lru time (relative to server.lruclock) */

    // 引用计数
    int refcount;

    // 指向实际值的指针
    void *ptr;

} robj;
</code></pre>
</div>

<p>type</p>

<table>
  <thead>
    <tr>
      <th>对象</th>
      <th>对象type属性的值</th>
      <th>type命令的输出</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>字符串对象</td>
      <td>REDIS_STRING</td>
      <td>“string”</td>
    </tr>
    <tr>
      <td>列表对象</td>
      <td>REDIS_LIST</td>
      <td>“list”</td>
    </tr>
    <tr>
      <td>哈希对象</td>
      <td>REDIS_HASH</td>
      <td>“hash”</td>
    </tr>
    <tr>
      <td>集合对象</td>
      <td>REDIS_SET</td>
      <td>“set”</td>
    </tr>
    <tr>
      <td>有序集合对象</td>
      <td>REDIS_ZSET</td>
      <td>“zset”</td>
    </tr>
  </tbody>
</table>

<p>encoding</p>

<table>
  <thead>
    <tr>
      <th>编码常量</th>
      <th>编码所对应的底层数据结构</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>REDIS_ENCODING_INT</td>
      <td>long类型的整数</td>
    </tr>
    <tr>
      <td>REDIS_ENCODING_EMBSTR</td>
      <td>embstr编码：的简单动态字符串</td>
    </tr>
    <tr>
      <td>REDIS_ENCODING_RAW</td>
      <td>简单动态字符串</td>
    </tr>
    <tr>
      <td>REDIS_ENCODING_HT</td>
      <td>字典</td>
    </tr>
    <tr>
      <td>REDIS_ENCODING_LINKEDLIST</td>
      <td>双端链表</td>
    </tr>
    <tr>
      <td>REDIS_ENCODING_ZIPLIST</td>
      <td>压缩列表</td>
    </tr>
    <tr>
      <td>REDIS_ENCODING_INTSET</td>
      <td>整数集合</td>
    </tr>
    <tr>
      <td>REDIS_ENCODING_SKIPLIST</td>
      <td>跳跃表和字典</td>
    </tr>
  </tbody>
</table>

<p>type和encoding可以相互结合.具体结合方式可参照开头的<a href="#memory">大图</a>。</p>

<p>eg:</p>

<ol>
  <li>
    <p>redisObject的type属性为REDIS_STRING、encoding为REDIS_ENCODING_INT表明使用整数值实现字符串对象</p>
  </li>
  <li>
    <p>redisObject的type属性为REDIS_HASH、encoding为REDIS_ENCODING_ZIPLIST表明使用压缩列表实现的哈希对象;encoding为REDIS_ENCODING_HT表明使用双向链表实现的哈希。</p>
  </li>
</ol>

<p>可以使用type和object encoding来查看redis对象的类型type和底层的数据结构类型encoding</p>

<div class="highlighter-rouge"><pre class="highlight"><code>127.0.0.1:6379&gt; set msg "xx"
OK
127.0.0.1:6379&gt; type msg
string
127.0.0.1:6379&gt; object encoding msg
"embstr"
</code></pre>
</div>

<h3 id="ds">数据结构</h3>

<p>redis底层的数据结构有这么几种:sds、list、dict、skipList、intSet、 zipList。</p>

<ol>
  <li>
    <p>对象的底层实现，比如列表对象listObject其底层可能就是使用的list数据结构。</p>
  </li>
  <li>
    <p>服务器的一些其他功能的底层实现也是这些数据结构，比如redisServer保持多个客户端的状态信息，监视器等功能底层实现也是list；redis本身就是个kv存储系统，redis数据库的底层就是使用了dict，然后dict对象底层也是用的dict，有点蒙了，可以对照上图。</p>
  </li>
</ol>

<h4 id="sds">sds</h4>

<p>sds: simple dynamic string</p>

<div class="highlighter-rouge"><pre class="highlight"><code>struct sdshdr {

    // 记录 buf 数组中已使用字节的数量
    // 等于 SDS 所保存字符串的长度
    int len;

    // 记录 buf 数组中未使用字节的数量
    int free;

    // 字节数组，用于保存字符串
    char buf[];

}; 
</code></pre>
</div>

<h4 id="list">list</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>typedef struct listNode {

    // 前置节点
    struct listNode *prev;

    // 后置节点
    struct listNode *next;

    // 节点的值
    void *value;

} listNode;


typedef struct list {

    // 表头节点
    listNode *head;

    // 表尾节点
    listNode *tail;

    // 链表所包含的节点数量
    unsigned long len;

    // 节点值复制函数
    void *(*dup)(void *ptr);

    // 节点值释放函数
    void (*free)(void *ptr);

    // 节点值对比函数
    int (*match)(void *ptr, void *key);

} list;
</code></pre>
</div>

<h4 id="dict">dict(hash)</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>typedef struct dict {

    // 类型特定函数
    dictType *type;

    // 私有数据
    void *privdata;

    // 哈希表
    dictht ht[2];

    // rehash 索引
    // 当 rehash 不在进行时，值为 -1
    int rehashidx; /* rehashing not in progress if rehashidx == -1 */

} dict;

typedef struct dictType {

    // 计算哈希值的函数
    unsigned int (*hashFunction)(const void *key);

    // 复制键的函数
    void *(*keyDup)(void *privdata, const void *key);

    // 复制值的函数
    void *(*valDup)(void *privdata, const void *obj);

    // 对比键的函数
    int (*keyCompare)(void *privdata, const void *key1, const void *key2);

    // 销毁键的函数
    void (*keyDestructor)(void *privdata, void *key);

    // 销毁值的函数
    void (*valDestructor)(void *privdata, void *obj);

} dictType;

typedef struct dictht {

    // 哈希表数组
    dictEntry **table;

    // 哈希表大小
    unsigned long size;

    // 哈希表大小掩码，用于计算索引值
    // 总是等于 size - 1
    unsigned long sizemask;

    // 该哈希表已有节点的数量
    unsigned long used;

} dictht;

typedef struct dictEntry {

    // 键
    void *key;

    // 值
    union {
        void *val;
        uint64_t u64;
        int64_t s64;
    } v;

    // 指向下个哈希表节点，形成链表
    struct dictEntry *next;

} dictEntry;
</code></pre>
</div>

<p>扩容与收缩、链地址法。</p>

<p>渐进式rehash</p>

<h4 id="skipList">skipList</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>typedef struct zskiplist {

    // 表头节点和表尾节点
    struct zskiplistNode *header, *tail;

    // 表中节点的数量
    unsigned long length;

    // 表中层数最大的节点的层数
    int level;

} zskiplist;


typedef struct zskiplistNode {

    // 后退指针
    struct zskiplistNode *backward;

    // 分值
    double score;

    // 成员对象
    robj *obj;

    // 层
    struct zskiplistLevel {

        // 前进指针
        struct zskiplistNode *forward;

        // 跨度
        unsigned int span;

    } level[];

} zskiplistNode;
</code></pre>
</div>

<p>跳跃表的介绍。</p>

<h4 id="intSet">intSet</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>typedef struct intset {

    // 编码方式
    uint32_t encoding;

    // 集合包含的元素数量
    uint32_t length;

    // 保存元素的数组
    int8_t contents[];

} intset;
</code></pre>
</div>

<p>类型转换</p>

<h4 id="zipList">zipList</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>typedef struct zlentry {

    // prevrawlen ：前置节点的长度
    // prevrawlensize ：编码 prevrawlen 所需的字节大小
    unsigned int prevrawlensize, prevrawlen;

    // len ：当前节点值的长度
    // lensize ：编码 len 所需的字节大小
    unsigned int lensize, len;

    // 当前节点 header 的大小
    // 等于 prevrawlensize + lensize
    unsigned int headersize;

    // 当前节点值所使用的编码类型
    unsigned char encoding;

    // 指向当前节点的指针
    unsigned char *p;

} zlentry;
</code></pre>
</div>

<p>连锁更新</p>

<h3 id="debug_redis">调试redis</h3>

<p>使用vi，ctags，cscope，gdb进行调试 参见<a href="/2016/02/28/view_source">我是这样看源码的</a></p>

<p>因为我们要调试，所以还是<a href="/2015/12/28/redis_basic#hello">使用源码进行安装</a></p>

<ol>
  <li>启动服务端redis-server</li>
  <li>启动客户端redis-cli</li>
  <li>gdb attach到服务进程上<code class="highlighter-rouge">gdb -p pid</code>，这种方式可以调试redis接收请求的过程，但是必须redis服务器启动起来。所以如果观察redis的启动流程正确的姿势应该是gdb可执行文件</li>
  <li>打断点，对不同数据结构进行断点调试
ps: mac上的gdb还需设置下: http://jingyan.baidu.com/article/925f8cb8fa362ec0dde0561a.html</li>
</ol>

<p>执行过程如下：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>cd /Users/lichuangjian/soft/redis-3.0-annotated
make install
gdb ./src/redis-server
b 3952
r
</code></pre>
</div>

<p><img src="/images/soft/gdb_redis.png" alt="gdb_redis" /></p>

<h3 id="redis_start">redis启动流程</h3>

<p>redis.c中有两个全局变量
<code class="highlighter-rouge">struct RedisServer * server</code>、 <code class="highlighter-rouge">struct RedisCommand *commandTable</code></p>

<ol>
  <li>
    <p>初始化redisServer的配置initServerConfig()</p>
  </li>
  <li>
    <p>如果指定了配置文件，加载配置文件，修改默认配置loadServerConfig()</p>
  </li>
  <li>
    <p>打开监听端口listenToPort()</p>
  </li>
  <li>
    <p>打开unix本地端口anetUnixServer()</p>
  </li>
  <li>
    <p>创建数据库并进行初始化（默认是16个）</p>
  </li>
  <li>
    <p>创建pubSub相关数据结构</p>
  </li>
  <li>
    <p>初始化server的其他一些配置</p>
  </li>
  <li>
    <p>为 serverCron() 创建时间事件aeCreateTimeEvent()</p>
  </li>
  <li>
    <p>为 TCP 连接关联连接应答（accept）处理器aeCreateFileEvent()</p>
  </li>
  <li>
    <p>为本地套接字关联应答处理器aeCreateFileEvent()</p>
  </li>
  <li>
    <p>如果AOF功能打开，打开或创建aof文件</p>
  </li>
  <li>
    <p>如果服务器以cluster方式运行，初始化cluster, clusterInit()</p>
  </li>
  <li>
    <p>初始化复制功能有关的脚本缓存replicationScriptCacheInit()</p>
  </li>
  <li>
    <p>初始化脚本系统scriptingInit()</p>
  </li>
  <li>
    <p>初始化慢查询功能slowlogInit()</p>
  </li>
  <li>
    <p>初始化BIO系统bioInit()</p>
  </li>
  <li>
    <p>从aof或者rdb文件中载入数据</p>
  </li>
  <li>
    <p>启动集群？</p>
  </li>
  <li>
    <p>运行事件处理器。</p>
  </li>
</ol>

<p>Q&amp;A ?</p>

<ol>
  <li>如何将其设置为守护进程的。</li>
</ol>

<h3 id="redis_accept_request">redis接受请求</h3>

<p><code class="highlighter-rouge">p (struct redisServer) server</code></p>

<p><code class="highlighter-rouge">p (struct redisClient) c</code></p>

<p>redis事件接口</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// 文件事件处理器，eg: readQueryFromClient、acceptTcpHandler、
// acceptUnixHandler、sendReplyToClient、acceptHandler ..
typedef void aeFileProc(struct aeEventLoop *eventLoop, int fd, void *clientData, int mask);
// 时间事件处理器，eg
typedef int aeTimeProc(struct aeEventLoop *eventLoop, long long id, void *clientData);
// 事件终结处理器，eg
typedef void aeEventFinalizerProc(struct aeEventLoop *eventLoop, void *clientData);
// 事件预处理器，eg
typedef void aeBeforeSleepProc(struct aeEventLoop *eventLoop);
</code></pre>
</div>

<p>redis命令实现接口</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// eg：setCommand，getCommand，zrangeCommand..
typedef void redisCommandProc(redisClient *c);
</code></pre>
</div>

<p>redis的事件包含有时间事件和文件事件。</p>

<p>以最简单的get xx为例</p>

<div class="highlighter-rouge"><pre class="highlight"><code>127.0.0.1:6379&gt; get msg
"heheda"
(3405.11s)
</code></pre>
</div>

<p>acceptTcpHandler</p>

<ol>
  <li>anetTcpAccept -&gt; anetGenericAccept : 创建客户端连接</li>
  <li>acceptCommonHandler -&gt; createClient :
    <ol>
      <li>分配redisClient内存空间，</li>
      <li>设置io非阻塞，</li>
      <li>禁用 Nagle 算法，</li>
      <li>设置tcpKeepAlive时间，</li>
      <li>添加读事件并绑定readQueryFromClient事件处理器,</li>
      <li>绑定client到db0,</li>
      <li>初始化事务和发布订阅相关数据结构</li>
      <li>…</li>
    </ol>
  </li>
</ol>

<p>readQueryFromClient</p>

<ol>
  <li>从缓冲区读取客户端命令内容</li>
  <li>processInputBuffer或者processMultibulkBuffer
    <ol>
      <li>解析命令sdssplitargs,并为解析后的每一个参数创建为一个stringObject（解析如下例子所示）</li>
      <li>执行命令processCommand
        <ol>
          <li>lookupCommand,根据命令名查找对应的redisCommand</li>
          <li>addReply</li>
        </ol>
      </li>
    </ol>

    <ul>
      <li>sds *arr = sdssplitargs(“timeout 10086\r\nport 123321\r\n”);</li>
      <li>会得出</li>
      <li>arr[0] = “timeout”</li>
      <li>arr[1] = “10086”</li>
      <li>arr[2] = “port”</li>
      <li>arr[3] = “123321</li>
    </ul>
  </li>
</ol>

<h4 id="reactor">reactor</h4>

<p>todo</p>

<p>redis的文件事件处理采用的是reactor模式，通过select/poll/epoll/kqueue这些I/O多路复用函数库，解决了一个线程处理多个连接的问题。
mac上其实现为kqueue，linux为epool，sun为select，可参见config.h和ae.c中的声明。</p>

<p>ae.c</p>

<div class="highlighter-rouge"><pre class="highlight"><code>#else
    #ifdef HAVE_EPOLL
    #include "ae_epoll.c"
    #else
        #ifdef HAVE_KQUEUE
        #include "ae_kqueue.c"
        #else
        #include "ae_select.c"
        #endif
    #endif
#endif
  
  
config.h
  
/* Test for polling API */
#ifdef __linux__
#define HAVE_EPOLL 1
#endif
 
#if (defined(__APPLE__) &amp;&amp; defined(MAC_OS_X_VERSION_10_6)) || defined(__FreeBSD__) || defined(__OpenBSD__) || defined (__NetBSD__)
#define HAVE_KQUEUE 1
#endif
 
#ifdef __sun
#include &lt;sys/feature_tests.h&gt;
#ifdef _DTRACE_VERSION
#define HAVE_EVPORT 1
#endif
#endif 
</code></pre>
</div>

<h3 id="redis_distributed">redis多机</h3>

<h3 id="redis_situation">redis使用场景</h3>

<h3 id="ref">参考</h3>

<p>[redis设计与实现]<a href="http://redisbook.com/">http://redisbook.com/</a></p>

<p>[mit公开课算法导论:跳跃表]<a href="http://open.163.com/movie/2010/12/7/S/M6UTT5U0I_M6V2TTJ7S.html">http://open.163.com/movie/2010/12/7/S/M6UTT5U0I_M6V2TTJ7S.html</a></p>

        <ul class="prev_next">
            
            <li>
                <span>上一篇</span>
                <a href="/2016/09/01/ThreadPoolExecutor">ThreadPoolEexcutor</a>
            </li>
            
            
        </ul>

        <!-- 多说评论 -->
        <div class="ds-share flat" data-thread-key="/2016/09/01/redis_source" data-title="redis源码分析"
             data-url="http://lcj1992.github.io/2016/09/01/redis_source">
            <div class="ds-share-inline">
                <ul class="ds-share-icons-16">

                    <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
                    <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
                    <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

                </ul>
                <div class="ds-share-icons-more">
                </div>
            </div>
        </div>
        <!-- 打赏 -->
        <div class="post-donate">
            <div id="donate_board" class="donate_bar center hidden">
                <a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a>
                <div class="donate_txt"> ↑<br>此文有用? 求鼓励!<br></div>
            </div>
            <div id="donate_guide" class="donate_bar center">
                <a href="/images/donate.jpg" title="此文有用? 求鼓励!" class="fancybox" rel="gallery">
                    <img src="/images/donate.jpg" title="微信打赏"></a>
            </div>
            <script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
                $('#donate_board').addClass('hidden');
                $('#donate_guide').removeClass('hidden');
            }
            </script>
        </div>
        <div class="ds-thread" data-thread-key="/2016/09/01/redis_source" data-title="redis源码分析"
             data-url="http://lcj1992.github.io/2016/09/01/redis_source"></div>
        <!-- 多说评论框 end -->
        <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
        <script type="text/javascript">
            var duoshuoQuery = {short_name: "lcj1992"};
            (function () {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';
                ds.async = true;
                ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        </script>

        <!-- jQuery -->
        <script src="/js/jquery.js"></script>

        <!-- Bootstrap Core JavaScript -->
        <script src="/js/bootstrap.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="/js/codeboy.js"></script>

        <script src="/js/bootstrap3-typeahead.js"></script>
        <script src="/js/jquery.hotkeys.js"></script>
        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function () {
                            (i[r].q = i[r].q || []).push(arguments)
                        }, i[r].l = 1 * new Date();
                a = s.createElement(o),
                        m = s.getElementsByTagName(o)[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-72949519-1', 'auto');
            ga('send', 'pageview');

        </script>

        <!-- TODO: only load in tag.html -->
        <script src="/js/jquery.tagcloud.js" type="text/javascript" charset="utf-8"></script>
        <script language="javascript">
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'}
            };
            $(function () {
                $('#tag_cloud a').tagcloud();
            });
        </script>

        <!-- async load function -->
        <script>
            function async(u, c) {
                var d = document, t = 'script',
                        o = d.createElement(t),
                        s = d.getElementsByTagName(t)[0];
                o.src = u;
                if (c) {
                    o.addEventListener('load', function (e) {
                        c(null, e);
                    }, false);
                }
                s.parentNode.insertBefore(o, s);
            }
        </script>

        <!-- Highlight.js -->
        <script>
            async("https://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () {
                hljs.initHighlightingOnLoad();
            })
        </script>
        <link href="https://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">


        <script>
            $(document).ready(function () {
                var time1 = 0;
                var show = false;
                var names = new Array(); //文章名字等
                var urls = new Array(); //文章地址
                $(document).keyup(function (e) {
                    var time2 = new Date().getTime();
                    if (e.keyCode == 17) {
                        var gap = time2 - time1;
                        time1 = time2;
                        if (gap < 500) {
                            if (show) {
                                $(".search-tool").css("display", "none");
                                show = false;
                            } else {
                                $(".search-tool").css("display", "block");
                                show = true;
                                $("#search-content").val("");
                                $("#search-content").focus();
                            }
                            time1 = 0;
                        }
                    } else if (e.keyCode == 27) {
                        $(".search-tool").css("display", "none");
                        show = false;
                        time1 = 0;
                    }
                });

                $("#search-content").keyup(function (e) {
                    var time2 = new Date().getTime();
                    if (window.event.keyCode == 17) {
                        var gap = time2 - time1;
                        time1 = time2;
                        if (gap < 500) {
                            if (show) {
                                $(".search-tool").css("display", "none");
                                show = false;
                            } else {
                                $(".search-tool").css("display", "block");
                                show = true;
                                $("#search-content").val("");
                                $("#search-content").focus();
                            }
                            time1 = 0;
                        }
                    }
                });

                $("#close-btn").click(function () {
                    $(".search-tool").css("display", "none");
                    show = false;
                    time1 = 0;
                });

                $("#search-btn").click(function () {
                    $(".search-tool").css("display", "block");
                    show = true;
                    $("#search-content").val("");
                    $("#search-content").focus();
                    time1 = 0;
                });
                // 家目录快捷键
                $(document).bind('keydown', 'alt+h', function () {
                    window.location.href = "/";
                });
                // 目录快捷键
                $(document).bind('keydown', 'alt+c', function () {
                    window.location.href = "/categories.html";
                });
                // 书单快捷键
                $(document).bind('keydown', 'alt+b', function () {
                    window.location.href = "/booklist.html";
                });
                // 个人介绍页快捷键
                $(document).bind('keydown', 'alt+a', function () {
                    window.location.href = "/about.html";
                });
                // 上一篇
                $(document).bind('keydown', 'alt+p', function () {
                    window.location.href = "/2016/09/01/ThreadPoolExecutor";
                });
                // 下一篇
                $(document).bind('keydown', 'alt+n', function () {
                    window.location.href = "";
                });

                $.getJSON("/search.json").done(function (data) {
                    if (data.code == 0) {
                        for (var index in data.data) {
                            var item = data.data[index];
                            names.push(item.title);
                            urls.push(item.url);
                        }

                        $("#search-content").typeahead({
                            source: names,

                            afterSelect: function (item) {
                                $(".search-tool").css("display", "none");
                                show = false;
                                window.location.href = (urls[names.indexOf(item)]);
                                return item;
                            }
                        });
                    }
                });

            });
        </script>

        <style>
            @media screen and (min-width: 768px) {
                .dropdown-menu {
                    float: none;
                    font-size: 20px;
                    width: 70%;
                    margin: 0 15%;
                }

                .search-tool ul {
                    width: 70%;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                .search-content {
                    width: 70%;
                    margin: 0 15%;
                    position: absolute;
                    top: 13%;
                    left: auto;
                    right: auto;
                    font-size: 22px;
                    height: 50px;
                    background-color: #eee;
                    color: black;
                    opacity: 1.0;
                }
            }

            @media screen and (max-width: 767px) {
                .dropdown-menu {
                    float: none;
                    font-size: 20px;
                    width: 96%;
                    margin: 0 2%;
                }

                .search-tool ul {
                    width: 96%;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }

                .search-content {
                    width: 96%;
                    margin: 0 2%;
                    position: absolute;
                    top: 10%;
                    left: auto;
                    right: auto;
                    font-size: 22px;
                    height: 50px;
                    background-color: #eee;
                    color: black;
                    opacity: 1.0;
                }
            }
        </style>
        <div class="search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right:  0px;
      opacity: 0.95; background-color: #111111; z-index: 9999; display: none;">
            <input type="text" class="form-control search-content" id="search-content" placeholder="文章标题 日期 标签">

            <div style="position: fixed; top: 16px; right: 16px;">
                <img src="/images/search/close.png" id="close-btn"/>
            </div>
        </div>

        <div style="position: fixed; right: 12px; top: 50%;bottom: 50%;">
            <img src="/images/search/search.png" id="search-btn" title="双击ctrl试一下"/>
        </div>

    </div>
</div>
</body>
</html>
